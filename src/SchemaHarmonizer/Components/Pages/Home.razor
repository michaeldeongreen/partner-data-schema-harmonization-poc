@page "/"
@rendermode InteractiveServer
@using SchemaHarmonizer.Components
@using Microsoft.AspNetCore.Components.Web
@using System.IO

<PageTitle>Schema Harmonizer</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Schema Harmonizer</h1>
        </div>
    </div>

    <!-- AI Connection Test Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">AI Model Connection</h5>
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-info" type="button" @onclick="TestAIConnection"
                            disabled="@isTestingConnection">
                            @if (isTestingConnection)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <text>Testing...</text>
                            }
                            else
                            {
                                <text>Test AI Connection</text>
                            }
                        </button>
                        @if (aiTestResult != null)
                        {
                            <div class="alert @(aiTestResult.IsConnected ? "alert-success" : "alert-danger") mb-0 py-2"
                                role="alert">
                                @aiTestResult.Message
                                @if (!string.IsNullOrEmpty(aiTestResult.ErrorDetails))
                                {
                                    <br>

                                    <small>@aiTestResult.ErrorDetails</small>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Customer Data Section -->
    <div class="row mb-4">
        <div class="col-12">
            <label class="form-label fw-bold">Customer Data:</label>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-primary" type="button" @onclick="BrowseNonStandardSchema">
                Browse
            </button>
        </div>
        <div class="col">
            <input type="text" class="form-control" @bind="nonStandardSchemaPath"
                placeholder="Select customer data file..." readonly />
        </div>
    </div>



    <!-- Enhanced Processing Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <!-- Annotations Section -->
                    <h5 class="card-title">
                        <span class="badge bg-success text-white"
                              data-bs-toggle="tooltip" 
                              data-bs-placement="top" 
                              title="Annotations provide structured data transformation rules for consistent and accurate processing">
                            Enhanced Processing Mode
                        </span>
                    </h5>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="useAnnotations" 
                               @onchange="ToggleAnnotations" checked="@useAnnotations">
                        <label class="form-check-label" for="useAnnotations">
                            Use annotations for enhanced data processing
                        </label>
                    </div>

                    @if (useAnnotations)
                    {
                        <div class="mb-3">
                            <label class="form-label">Select Annotation File:</label>
                            <select class="form-select" @onchange="OnAnnotationSelected" value="@annotationPath">
                                <option value="">-- Select an annotation file --</option>
                                @foreach (var annotationFile in availableAnnotations)
                                {
                                    var fileName = Path.GetFileNameWithoutExtension(annotationFile);
                                    <option value="@annotationFile">@fileName</option>
                                }
                            </select>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Harmonization Prompt Section -->
    <div class="row mb-4">
        <div class="col-12">
            <label class="form-label fw-bold">AI Processing Prompt:</label>
            <small class="text-muted d-block mb-2">
                Use {TEMPLATE_DATA} for the template, {INPUT_DATA} for input data, and {EXAMPLES}
                for context-aware examples
                @if (useAnnotations && annotation != null)
                {
                    <br>

                    <strong>Annotation instructions will be automatically added to enhance processing.</strong>
                }
            </small>
            <textarea class="form-control" rows="20" @bind="processingPrompt"
                placeholder="Enter your data processing prompt here..."
                style="resize: vertical; font-family: monospace; font-size: 12px;"></textarea>
        </div>
    </div>

    <!-- JSON Output Section -->
    <div class="row">
        <div class="col-12 mb-2">
            <div class="d-flex justify-content-between align-items-center">
                <label class="form-label fw-bold mb-0">Results Comparison:</label>
                @if (currentTokenStats != null)
                {
                    <div class="d-flex gap-3">
                        <span class="badge bg-info text-dark">
                            <i class="bi bi-calculator me-1"></i>
                            Input: @InputTokens.ToString("N0") tokens
                        </span>
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-arrow-right me-1"></i>
                            Est. Response: @EstimatedResponseTokens.ToString("N0") tokens
                        </span>
                        <span
                            class="badge @(EstimatedTotalTokens > 15000 ? "bg-danger" : EstimatedTotalTokens > 10000 ? "bg-warning" : "bg-success")">
                            <i class="bi bi-speedometer2 me-1"></i>
                            Est. Total: @EstimatedTotalTokens.ToString("N0") tokens
                        </span>
                    </div>
                }
            </div>
        </div>
        
        @if (!string.IsNullOrWhiteSpace(jsonOutput))
        {
            <!-- Canonical Schema Column -->
            <div class="col-6">
                <label class="form-label fw-bold mb-2">Canonical Schema Example:</label>
                <textarea class="form-control" rows="15" @bind="canonicalSchemaContent"
                    placeholder="Canonical schema will appear here..." readonly style="resize: none;"></textarea>
            </div>
            
            <!-- Harmonized Output Column -->
            <div class="col-6">
                <label class="form-label fw-bold mb-2">Harmonized JSON Output:</label>
                <div class="position-relative">
                    <textarea class="form-control" rows="15" @bind="jsonOutput"
                        placeholder="Harmonized JSON will appear here..." readonly style="resize: none;"></textarea>
                    <div class="position-absolute d-flex gap-2" style="bottom: 10px; right: 10px;">
                        <button class="btn btn-success" @onclick="ProcessData" disabled="@(!CanProcess || isProcessing)">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <text>Processing...</text>
                            }
                            else
                            {
                                <text>Process</text>
                            }
                        </button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- Single column when no results yet -->
            <div class="col-12">
                <div class="position-relative">
                    <textarea class="form-control" rows="15" @bind="jsonOutput"
                        placeholder="Harmonized JSON will appear here..." readonly style="resize: none;"></textarea>
                    <div class="position-absolute d-flex gap-2" style="bottom: 10px; right: 10px;">
                        <button class="btn btn-success" @onclick="ProcessData" disabled="@(!CanProcess || isProcessing)">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <text>Processing...</text>
                            }
                            else
                            {
                                <text>Process</text>
                            }
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>

</div>

<!-- File Browser Modal -->
<FileBrowser @ref="nonStandardFileBrowser" Title="Customer Data File" FileType="all" IsStandard="false"
    OnFileSelected="OnNonStandardSchemaSelected" />